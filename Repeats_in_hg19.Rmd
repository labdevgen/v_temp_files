---
title: "Repeats in hg19 (RepeatMasker base)"
author: "Ronica K"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

###Loading/cleaning

```{r, echo=F, message=F, warning=F}
library(GenomicRanges)
library(AnnotationHub)
library(ggplot2)

#max gap between repeats
N <- 10^6
#max interval length
M <- 10^5
```

UCSC RepeatMasker package

```{r, echo=F, cache=T}
ah <- AnnotationHub()
hh <- subset(ah, species=='Homo sapiens' & genome=='hg19')
qh <- query(hh, 'RepeatMasker')
qh
```

```{r, echo=F, cache=T, message=F, warning=F}
rm <- qh[[1]]
rm
```

Subsetting the data to include only chromosomes 1-22, X, Y; setting strands to *

```{r, echo=F, cache=T}
seqlevels(rm, force=TRUE) <- paste0("chr", c(1:22, "X", "Y"))
strand(rm) <- '*'
rm
```

Number of unique repeat sequences

```{r, echo=F}
length(unique(rm$name))
```

###Repeat coverage

Coverage distribution

```{r, echo=F, cache=T}
Y <- sapply(split(rm, rm$name), function(x) sum(width(x)))
#sum(gr > 0)
dy <- do.call(rbind, Map(data.frame, Y=Y))
summary(dy)
```

```{r, echo=F, cache=T}
Y[Y==min(Y)]
Y[Y==max(Y)]
```

Square root scale, red median, blue mean
```{r, echo=F, cache=T}
ggplot(dy, aes(Y)) + geom_histogram(binwidth=100) + geom_vline(xintercept=median(Y), color='red') + scale_x_sqrt() + geom_vline(xintercept=mean(Y), color='blue')
```

Repeat coverage by chromosome

```{r, echo=F, cache=T}
cr <- sapply(split(rm, seqnames(rm)), function(x) sum(width(x)))
dc <- do.call(rbind, Map(data.frame, Mb=cr/10^6))
dc
ggplot(dc, aes(y=Mb, x=row.names(dc))) + geom_bar(stat="identity") + scale_x_discrete(limits=paste0("chr", c(1:22, "X", "Y"))) + coord_flip()
```

###MADE1 repeat sequence 
http://www.repeatmasker.org/cgi-bin/ViewRepeat?id=MADE1


```{r, echo=F}
seq <- 'MADE1'
seqsubset <- rm[(elementMetadata(rm)[,1]==seq)]
seqsubset
seqsubset[seqnames(seqsubset)=='chrY']

numrep <- sapply(split(seqsubset, seqnames(seqsubset)), function(x) length(ranges(x)))
covrep <- sapply(split(seqsubset, seqnames(seqsubset)), function(x) sum(width(x)))

do.call(rbind, Map(data.frame, num.ranges=numrep, genome.covered=covrep))
```

__Rle coverage__

- genome

```{r, echo=F}
cov_seq <- coverage(seqsubset)
cov_seq
```

- chromosome Y

```{r, echo=F}
cov_seq$chrY
rl <- runLength(cov_seq$chrY)
rl
```

__Reduced ranges__

- genome

```{r, echo=F}
red <- reduce(seqsubset, min.gapwidth=N+1, ignore.strand=TRUE)
numredrep <- sapply(split(red, seqnames(red)), function(x) length(ranges(x)))
red
```

- chromosome Y

```{r, echo=F}
red[seqnames(red)=='chrY']
```

__Number of gaps(including flanks) > N(1Mb) / Number of ranges after reduction__

```{r, echo=F, cache=T}
gaps <- sum(runLength(cov_seq)[runValue(cov_seq)==0] > N)

do.call(rbind, Map(data.frame, num.gaps=gaps, num.red.ranges=numredrep))
```

Gaps on chromosome Y

```{r, echo=F}
rl[runValue(cov_seq$chrY)==0 & rl>N]

```

__Rle coverage (after reduction)__

- genome

```{r, echo=F, cache=T}
red_cov <- coverage(red)
red_cov
```

- chromosome Y

```{r, echo=F}
red_cov$chrY
runLength(red_cov$chrY)
```

__Max MADE1 cluster__

```{r, echo=F}
max(width(red))

red[width(red)==max(width(red))]

red_cov$chrX
runLength(red_cov$chrX)
```

###Maximum Cluster Length 

```{r, echo=F, cache=T}
X <- sapply(split(rm, rm$name), function(x) max(width(reduce(x, min.gapwidth=N+1L, ignore.strand=TRUE))))
```

Distribution
```{r, echo=F, cache=T}
dx <- do.call(rbind, Map(data.frame, X=X))
summary(dx)
```

```{r, echo=F, cache=T}
X[X==min(X)]
X[X==max(X)]
```

Square root scale, red median, blue mean

```{r, echo=F, cache=T}
ggplot(dx, aes(X)) + geom_histogram(binwidth=150) + geom_vline(xintercept=median(X), color='red') + geom_vline(xintercept=mean(X), color='blue') + scale_x_sqrt()
```

###Maximum Cluster Length vs Total Coverage

```{r, echo=F}
df <- do.call(rbind, Map(data.frame, X=X, Y=Y))
head(df)
```


```{r, echo=F, cache=T}
ggplot(df, aes(X/10^6, Y/10^6)) + geom_point(shape=1) + labs(x ='Max Cluster Length, Mb', y = 'Total Coverage, Mb') + geom_vline(xintercept=median(X)/10^6, color='red') + geom_hline(yintercept=median(Y)/10^6, color='red')
```

log10 scale

```{r, echo=F, cache=T}
ggplot(df, aes(X/10^6, Y/10^6)) + geom_point(shape=1) + scale_x_log10() + scale_y_log10() + labs(x ='Max Cluster Length, Mb (log10 scale)', y = 'Total Coverage, Mb (log10 scale)') + geom_vline(xintercept=log10(median(X)/10^6), color='red') + geom_hline(yintercept=log10(median(Y)/10^6+1), color='red')
```

###Total Genome within Clusters <= 100Kb Covered by Repeats (excluding gaps)

Distribution

```{r, echo=F, cache=T}
Z <- sapply(split(rm, rm$name), function(x){
  redr <- reduce(x, min.gapwidth=N+1L)
  sum(width(x[x %within% redr[width(redr)<=M]]))
  })
dnz <- do.call(rbind, Map(data.frame, Z=Z))
summary(dnz)
```

```{r, echo=F, cache=T}
Z[Z==min(Z)]
Z[Z==max(Z)]
```

Square root scale, red median, blue mean

```{r, echo=F, cache=T}
ggplot(dnz, aes(Z)) + geom_histogram(binwidth=25) + geom_vline(xintercept=median(Z), color='red') + geom_vline(xintercept=mean(Z), color='blue') + scale_x_sqrt()
```

###Session Info

```{r, echo=F}
sessionInfo()

```